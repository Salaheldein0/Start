<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Laundry Cycle Starter (Web Bluetooth)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; background: #0f172a; color: #e2e8f0; }
    .wrap { max-width: 760px; margin: 0 auto; padding: 20px; }
    h1 { font-size: 1.2rem; margin: 0 0 8px; }
    p { margin: 6px 0 14px; color: #cbd5e1; }
    .card { background: #111827; border: 1px solid #334155; border-radius: 14px; padding: 14px; margin: 12px 0; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; }
    button {
      border: 1px solid #475569; background: #1e293b; color: #e2e8f0;
      padding: 10px 12px; border-radius: 10px; font-size: 0.95rem; cursor: pointer;
    }
    button:hover { background: #273449; }
    button:disabled { opacity: 0.55; cursor: not-allowed; }
    .ok { color: #22c55e; }
    .bad { color: #ef4444; }
    .warn { color: #f59e0b; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
    #log {
      white-space: pre-wrap; background: #020617; border: 1px solid #334155;
      padding: 12px; border-radius: 10px; max-height: 320px; overflow: auto;
    }
    .small { font-size: 0.85rem; color: #94a3b8; }
    .pill { display: inline-block; border: 1px solid #475569; border-radius: 999px; padding: 2px 8px; margin-left: 6px; font-size: 12px; color: #93c5fd; }
    .map { margin-top: 8px; padding: 10px; border: 1px dashed #475569; border-radius: 10px; background: #0b1220; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Laundry Cycle Starter <span class="pill">Web Bluetooth</span></h1>
    <p>Make sure you are in the laundry room and Bluetooth is enabled.</p>

    <div class="card">
      <div class="row">
        <button id="connectBtn">Connect Device</button>
        <button id="disconnectBtn" disabled>Disconnect</button>
      </div>
      <p class="small" id="status">Status: not connected</p>

      <p class="small mono">
        RX UUID: 569a2000-b87f-490c-92cb-11ba5ea5167c<br>
        TX UUID: 569a2001-b87f-490c-92cb-11ba5ea5167c
      </p>

      <div class="map small">
        <strong>When selecting a device:</strong><br>
        Use <strong>Washer 1 (AWYDLOOBYZR1)</strong><br>
        Use <strong>Dryer 4</strong> for address <strong class="mono">30:30:f9:fe:4c:16</strong>
      </div>

      <p class="small" id="envNote"></p>
    </div>

    <div class="card">
      <div class="row">
        <button id="washerBtn" disabled>Washer 1 - Full wash</button>
        <button id="dryer15Btn" disabled>Dryer 4 - 15 min cycle</button>
        <button id="dryerFullBtn" disabled>Dryer 4 - Full dry</button>
      </div>
    </div>

    <div class="card">
      <strong>Log</strong>
      <div id="log" class="mono"></div>
    </div>
  </div>

  <script>
    // ===== Constants from your Python app =====
    const RX_UUID = "569a2000-b87f-490c-92cb-11ba5ea5167c"; // notify: device -> host
    const TX_UUID = "569a2001-b87f-490c-92cb-11ba5ea5167c"; // write: host -> device

    // Known service UUID candidates (needed for browser permission model)
    // IMPORTANT: optionalServices must contain SERVICE UUIDs, not characteristic UUIDs.
    // We include both known UUIDs as requested by browser error guidance.
    const OPTIONAL_SERVICE_UUIDS = [RX_UUID, TX_UUID];

    // Reference info
    const DRYER4_ADDRESS = "30:30:f9:fe:4c:16";
    const WASHER1_ADV_NAME = "AWYDLOOBYZR1";

    const CMD = {
      HANDSHAKE: "[HANDSHAKE:ENABLE]",
      VERSION: "[VERSION]",
      COIN_DISABLE: "[COIN:DISABLE:OCCUPIED_LOW]",
      EXEC: "[EXEC]",
      ACTIVATE_WASHER_FULL: "[ACTIVATE:01:PULSE:OCCUPIED_LOW:00000000:00000032:00000032:0003:GZS979139]",
      ACTIVATE_DRYER_FULL:  "[ACTIVATE:01:PULSE:OCCUPIED_LOW:00000000:00000032:00000032:0004:CJS795938]",
      ACTIVATE_DRYER_15:    "[ACTIVATE:01:PULSE:OCCUPIED_LOW:00000000:00000032:00:0001:CJS795938]"
    };

    // ===== State =====
    let device = null;
    let server = null;
    let rxChar = null;
    let txChar = null;

    let rxBuf = new Uint8Array(0);
    const messageQueue = [];
    let waiters = [];

    const enc = new TextEncoder();
    const dec = new TextDecoder("utf-8", { fatal: false });

    // ===== UI =====
    const els = {
      connectBtn: document.getElementById("connectBtn"),
      disconnectBtn: document.getElementById("disconn
